{"version":3,"sources":["../../source/middleware/session.js"],"names":["redis_options","Error","ttl","generate_id","sync","is_unique","id","redis_client","exists","prefix","generate_unique_id","require","createClient","host","redis","port","auth_pass","password","koa_convert","session","key","cookie","maxAge","genSid","store","redis_store","client"],"mappings":";;;;;;;;;;;;;;kBAkBe,UAASA,aAAT,EACf;AACC,OAAM,IAAIC,KAAJ,qGAAN;;AAEA,KAAMC,MAAM,KAAK,EAAL,GAAU,IAAtB,CAHD,CAG4B;;AAE3B,KAAIF,aAAJ,EACA;AAAA,MAUUG,WAVV,GAUC,SAASA,WAAT,GACA;AACC,UAAO,kBAAIC,IAAJ,CAAS,EAAT,CAAP,CADD,CACqB;AACpB,GAbF;;AAAA,MAegBC,SAfhB;AAAA,yEAeC,iBAAyBC,EAAzB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAEgB,yBAAUC,aAAaC,MAAvB,EAA+BD,YAA/B,EAA6CE,SAASH,EAAtD,CAFhB;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAfD;;AAAA,mBAegBD,SAfhB;AAAA;AAAA;AAAA;;AAAA,MAoBgBK,kBApBhB;AAAA,0EAoBC;AAAA;AAAA;AAAA;AAAA;AAAA;AAEOJ,UAFP,GAEYH,aAFZ;AAAA;AAAA,eAGWE,UAAUC,EAAV,CAHX;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,0CAKSA,EALT;;AAAA;AAAA,0CAOQI,oBAPR;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IApBD;;AAAA,mBAoBgBA,kBApBhB;AAAA;AAAA;AAAA;;AACC,MAAMH,eAAeI,QAAQ,OAAR,EAAiBC,YAAjB,CACpB;AACAC,SAAYb,cAAcc,KAAd,CAAoBD,IADhC;AAEAE,SAAYf,cAAcc,KAAd,CAAoBC,IAFhC;AAGAC,cAAYhB,cAAcc,KAAd,CAAoBG,QAHhC,CAGyC;AAHzC,GADoB,CAArB;;AAOA,MAAMR,SAAS,eAAf;;AAsBA,SAAOS,YAAYC,QAClB;AACAC,QAAS,YADT;AAEAX,iBAFA;AAGAY,WACA;AACCC,YAASpB;AADV,IAJA;AAOAA,WAPA;AAQAqB,WAASb,kBART;AASAc,UAASC,YACR;AACAC,YAASnB;AADT,IADQ;AATT,GADkB,CAAZ,CAAP;AAeA,EA9CD,MAgDA;AACC,SAAOW,YAAYC,QAClB;AACAC,QAAK,YADL;AAEA;AACAC,WACA;AACCC,YAASpB;AADV;AAJA,GADkB,CAAZ,CAAP;AASA;AACD,C;;AArED;;;;AAEA;;;;;;qCAhBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"session.js","sourcesContent":["// import koa_convert   from 'koa-convert'\n//\n// import session       from 'koa-generic-session'\n// import redis_store   from 'koa-redis'\n//\n// // forked from the original repo as of 25.01.2016\n// // https://github.com/halt-hammerzeit/generic-session\n// import session       from './koa-generic-session'\n// // forked from the original repo as of 25.01.2016\n// // https://github.com/halt-hammerzeit/koa-redis\n// import redis_store   from './koa-redis'\n//\n// npm install koa-convert copy-to@2 crc@3 debug@2 parseurl@1 --save\n\nimport uid from 'uid-safe'\n\nimport promisify from '../promisify'\n\nexport default function(redis_options)\n{\n\tthrow new Error(`Session support is currently turned off. Try using JSON Web Tokens to store session data instead.`)\n\n\tconst ttl = 15 * 60 * 1000 // 15 minutes // session timeout, in seconds\n\n\tif (redis_options)\n\t{\n\t\tconst redis_client = require('redis').createClient\n\t\t({\n\t\t\thost      : redis_options.redis.host,\n\t\t\tport      : redis_options.redis.port,\n\t\t\tauth_pass : redis_options.redis.password // auth_pass\n\t\t})\n\n\t\tconst prefix = 'user:session:'\n\n\t\tfunction generate_id()\n\t\t{\n\t\t\treturn uid.sync(24) // 24 is \"byte length\"; string length is 32 symbols\n\t\t}\n\n\t\tasync function is_unique(id)\n\t\t{\n\t\t\treturn !(await promisify(redis_client.exists, redis_client)(prefix + id))\n\t\t}\n\n\t\tasync function generate_unique_id()\n\t\t{\n\t\t\tconst id = generate_id()\n\t\t\tif (await is_unique(id))\n\t\t\t{\n\t\t\t\treturn id\n\t\t\t}\n\t\t\treturn generate_unique_id()\n\t\t}\n\n\t\treturn koa_convert(session\n\t\t({\n\t\t\tkey    : 'session:id',\n\t\t\tprefix,\n\t\t\tcookie :\n\t\t\t{\n\t\t\t\tmaxAge : ttl\n\t\t\t},\n\t\t\tttl, \n\t\t\tgenSid : generate_unique_id,\n\t\t\tstore  : redis_store\n\t\t\t({\n\t\t\t\tclient : redis_client\n\t\t\t})\n\t\t}))\n\t}\n\telse\n\t{\n\t\treturn koa_convert(session\n\t\t({\n\t\t\tkey: 'session:id',\n\t\t\t// ttl,\n\t\t\tcookie :\n\t\t\t{\n\t\t\t\tmaxAge : ttl\n\t\t\t}\n\t\t}))\n\t}\n}"]}