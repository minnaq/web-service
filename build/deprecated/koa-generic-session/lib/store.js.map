{"version":3,"sources":["../../../../source/deprecated/koa-generic-session/lib/store.js"],"names":["util","require","EventEmitter","debug","copy","defaultOptions","prefix","Store","client","options","and","to","call","on","emit","bind","inherits","prototype","get","sid","data","cookie","expires","Date","set","sess","ttl","destroy","bump","maxage","Math","ceil","getTime","now","module","exports"],"mappings":"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","file":"store.js","sourcesContent":["/**!\n * koa-generic-session - lib/store.js\n * Copyright(c) 2014\n * MIT Licensed\n *\n * Authors:\n *   dead_horse <dead_horse@qq.com> (http://deadhorse.me)\n */\n\n'use strict';\n\n/**\n * Module dependencies.\n */\n\nvar util = require('util');\nvar EventEmitter = require('events').EventEmitter;\nvar debug = require('debug')('koa-generic-session:store');\nvar copy = require('copy-to');\n\nvar defaultOptions = {\n  prefix: 'koa:sess:'\n};\n\nfunction Store(client, options) {\n  this.client = client;\n  this.options = {};\n  copy(options).and(defaultOptions).to(this.options);\n  EventEmitter.call(this);\n\n  // delegate client connect / disconnect event\n  if (typeof client.on === 'function') {\n    client.on('disconnect', this.emit.bind(this, 'disconnect'));\n    client.on('connect', this.emit.bind(this, 'connect'));\n  }\n}\n\nutil.inherits(Store, EventEmitter);\n\nStore.prototype.get = function *(sid) {\n  var data;\n  sid = this.options.prefix + sid;\n  debug('GET %s', sid);\n  data = yield this.client.get(sid);\n  if (!data) {\n    debug('GET empty');\n    return null;\n  }\n  if (data && data.cookie && typeof data.cookie.expires === 'string') {\n    // make sure data.cookie.expires is a Date\n    data.cookie.expires = new Date(data.cookie.expires);\n  }\n  debug('GOT %j', data);\n  return data;\n};\n\nStore.prototype.set = function *(sid, sess) {\n  sid = this.options.prefix + sid;\n  var ttl = this.ttl();\n  debug('SET key: %s, value: %s, ttl: %d', sid, sess, ttl);\n  yield this.client.set(sid, sess, ttl);\n  debug('SET complete');\n};\n\nStore.prototype.destroy = function *(sid) {\n  sid = this.options.prefix + sid;\n  debug('DEL %s', sid);\n  yield this.client.destroy(sid);\n  debug('DEL %s complete', sid);\n};\n\nStore.prototype.bump = function *(sid) {\n  if (!this.client.bump) {\n    return debug('BUMP not implemented');\n  }\n  sid = this.options.prefix + sid;\n  var ttl = this.ttl();\n  debug('BUMP %s, ttl: %d', sid, ttl);\n  yield this.client.bump(sid, ttl);\n  debug('BUMP complete');\n};\n\nStore.prototype.ttl = function () {\n  var ttl = this.options.ttl;\n  if (!ttl) {\n    var maxage = this.options.cookie && this.options.cookie.maxage;\n    if (typeof maxage === 'number') {\n      ttl = maxage;\n    }\n    // if has cookie.expires, ignore cookie.maxage\n    if (this.options.cookie && this.options.cookie.expires) {\n      ttl = Math.ceil(this.options.cookie.expires.getTime() - Date.now());\n    }\n  }\n  return ttl;\n};\n\nmodule.exports = Store;\n"]}